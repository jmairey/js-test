<!DOCTYPE html>
<html>
  <head>
    <title>GameLoop2.html</title>

    <style type="text/css" media="screen">
      canvas { border: 1px solid; }
    </style>

    <script type="text/javascript">

    var gKeyPressed = [];

    var gKey = {
      LEFT: 37,
      UP: 38,
      RIGHT: 39,
      DOWN: 40,
      j: 74,
      k: 75,
      h: 72,
      l:76,
    };

    function  isKeyDown(keyCode) {
      return gKeyPressed[keyCode];
    }

    function onKeyDown(event) {
      gKeyPressed[event.keyCode] = true;
    }

    function onKeyUp(event) {
      gKeyPressed[event.keyCode] = false;
    }
        
    window.addEventListener('keyup', function(event) { onKeyUp(event); }, false);
    window.addEventListener('keydown', function(event) { onKeyDown(event); }, false);

    var Game = {
      fps: 60,
      width: 800,
      height: 600,
    };

    Game._onEachFrame = (function() {
      return function(cb) {
        setInterval(cb, 1000 / Game.fps);
      }
    })
    ();  // argument is a function that is invoked and 
         // returns a function that takes a callback and passes it to 
         // setInterval to run our gameloop... tricky!
    
    Game.start = function() {
      Game.canvas = document.createElement("canvas");
      Game.canvas.width = Game.width;
      Game.canvas.height = Game.height;

      Game.context = Game.canvas.getContext("2d");

      document.body.appendChild(Game.canvas);

      Game.player = new Player();

      Game._onEachFrame(Game.run);
    };
    
    Game.run = (function() {
      var loops = 0; 
      var skipTicks = 1000 / Game.fps;
      var maxFrameSkip = 10;
      var nextGameTick = (new Date).getTime();
      var lastGameTick;

      return function() {
        loops = 0;

        while ((new Date).getTime() > nextGameTick) {
          Game.update();
          nextGameTick += skipTicks;
          loops++;
        }

        if (loops) Game.draw();
      }
    })();
    
    Game.draw = function() {
      Game.context.clearRect(0, 0, Game.width, Game.height);
      Game.player.draw(Game.context);
    };
    
    Game.update = function() {
      Game.player.update();
    };

    function Player() {
      this.x = Game.width/4;
      this.y = Game.height/4;
      this.width = 16;
      this.height = 16;
    }

    Player.prototype.draw = function(context) {
      context.fillRect(this.x, this.y, this.width, this.height);
    };

    Player.prototype.moveLeft = function() {
      this.x -= 1;
    };

    Player.prototype.moveRight = function() {
      this.x += 1;
    };

    Player.prototype.moveUp = function() {
      this.y -= 1;
    };

    Player.prototype.moveDown = function() {
      this.y += 1;
    };
    
    Player.prototype.update = function() {
      if (isKeyDown(gKey.UP)) this.moveUp();
      if (isKeyDown(gKey.k)) this.moveUp();
      if (isKeyDown(gKey.LEFT)) this.moveLeft();
      if (isKeyDown(gKey.h)) this.moveLeft();
      if (isKeyDown(gKey.DOWN)) this.moveDown();
      if (isKeyDown(gKey.j)) this.moveDown();
      if (isKeyDown(gKey.RIGHT)) this.moveRight();
      if (isKeyDown(gKey.l)) this.moveRight();
    };
    </script>
  </head>
  <body onload="Game.start()">
  </body>
</html>
