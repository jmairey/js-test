<!DOCTYPE html>
<html>
  <head>
    <title>GameLoop2.html</title>

    <style type="text/css" media="screen">
      canvas { border: 1px solid; }
    </style>

    <script type="text/javascript">

    var gKeyPressed = [];

    var gKey = {
      LEFT: 37,
      UP: 38,
      RIGHT: 39,
      DOWN: 40,
      j: 74,
      k: 75,
      h: 72,
      l:76,
    };

    function  isKeyDown(keyCode) {
      return gKeyPressed[keyCode];
    }

    function onKeyDown(event) {
      gKeyPressed[event.keyCode] = true;
    }

    function onKeyUp(event) {
      gKeyPressed[event.keyCode] = false;
    }
        
    //window.addEventListener('keyup', function(event) { onKeyUp(event); }, false);
    window.addEventListener('keyup', onKeyUp, false);

    window.addEventListener('keydown', onKeyDown, false);

    var Game = {
      fps: 60,
      width: 800,
      height: 600,
    };

    /*
    Game._onEachFrame = (function() {
      return function(cb) {
        setInterval(cb, Game.interval);
      }
    })
    ();  // argument is a function that is invoked and 
         // returns a function that takes a callback and passes it to 
         // setInterval to run our gameloop... tricky!
         */

    var gNextGameTick = (new Date).getTime();
    
    function runGame() {

      var loops = 0;

      while ((new Date).getTime() > gNextGameTick) {
        updateGame();
        gNextGameTick += Game.interval;
        loops++;
      }

      // we can update more than we draw. we don't draw if we don't update..
      if (loops) { 
        drawGame();
      }
    }
    
    function drawGame() {
      //Game.context.clearRect(0, 0, Game.width, Game.height);
      Game.player.draw(Game.context);
    }
    
    function updateGame() {
      Game.player.update();
    }
    
    function Player() {
      this.x = Game.width/4;
      this.y = Game.height/4;
      this.width = 16;
      this.height = 16;
    }

    Player.prototype.draw = function(context) {
      context.fillRect(this.x, this.y, this.width, this.height);
    };

    Player.prototype.moveLeft = function() {
      this.x -= 1;
    };

    Player.prototype.moveRight = function() {
      this.x += 1;
    };

    Player.prototype.moveUp = function() {
      this.y -= 1;
    };

    Player.prototype.moveDown = function() {
      this.y += 1;
    };
    
    Player.prototype.update = function() {
      if (isKeyDown(gKey.UP)) this.moveUp();
      if (isKeyDown(gKey.k)) this.moveUp();
      if (isKeyDown(gKey.LEFT)) this.moveLeft();
      if (isKeyDown(gKey.h)) this.moveLeft();
      if (isKeyDown(gKey.DOWN)) this.moveDown();
      if (isKeyDown(gKey.j)) this.moveDown();
      if (isKeyDown(gKey.RIGHT)) this.moveRight();
      if (isKeyDown(gKey.l)) this.moveRight();
    };

    function startGame() {
      Game.interval = 1000/Game.fps;

      Game.canvas = document.createElement("canvas");
      Game.canvas.width = Game.width;
      Game.canvas.height = Game.height;

      Game.context = Game.canvas.getContext("2d");

      document.body.appendChild(Game.canvas);

      Game.player = new Player();

      setInterval(runGame, Game.interval);
    }

    </script>
  </head>
  <body onload="startGame()">
  <p> some text </p>
  </body>
</html>
